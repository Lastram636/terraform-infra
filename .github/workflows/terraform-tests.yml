name: Terraform Tests

on:
  push:
    branches:
      - main
  pull_request:

permissions:
  contents: read
  pull-requests: write

jobs:
  checkov:
    name: "Checkov Scan"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Checkov GitHub Action
        uses: bridgecrewio/checkov-action@master
        with:
          directory: ./
          soft_fail: true

  plan:
    name: "Terraform Plan"
    runs-on: ubuntu-latest
    env:
      GOOGLE_CREDENTIALS: ${{ secrets.GCP_SA_KEY }}
    steps:
      - uses: actions/checkout@v3
      - uses: hashicorp/setup-terraform@v2

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v1'

      - name: Ensure State Bucket Exists
        run: |
          if ! gcloud storage buckets describe gs://${{ secrets.TF_STATE_BUCKET }} > /dev/null 2>&1; then
            echo "Bucket does not exist. Creating..."
            gcloud storage buckets create gs://${{ secrets.TF_STATE_BUCKET }} --project=${{ secrets.GCP_PROJECT_ID }} --location=us-central1
          else
            echo "Bucket exists."
          fi

      - name: Terraform Init
        run: terraform init -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}"

      - name: Terraform Validate
        run: terraform validate -no-color

      - name: Terraform Plan
        id: plan
        run: terraform plan -no-color -input=false -var="project_id=${{ secrets.GCP_PROJECT_ID }}" -var="db_password=${{ secrets.DB_PASSWORD }}"

  apply:
    name: "Terraform Apply"
    needs: [plan, checkov]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment: production # <--- This enables Manual Approval
    env:
      GOOGLE_CREDENTIALS: ${{ secrets.GCP_SA_KEY }}
    steps:
      - uses: actions/checkout@v3
      - uses: hashicorp/setup-terraform@v2

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v1'

      - name: Ensure State Bucket Exists
        run: |
           if ! gcloud storage buckets describe gs://${{ secrets.TF_STATE_BUCKET }} > /dev/null 2>&1; then
             gcloud storage buckets create gs://${{ secrets.TF_STATE_BUCKET }} --project=${{ secrets.GCP_PROJECT_ID }} --location=us-central1
           fi

      - name: Terraform Init
        run: terraform init -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}"

      - name: Terraform Apply
        run: terraform apply -auto-approve -input=false -var="project_id=${{ secrets.GCP_PROJECT_ID }}" -var="db_password=${{ secrets.DB_PASSWORD }}"
